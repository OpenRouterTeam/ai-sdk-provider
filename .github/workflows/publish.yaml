name: Release
on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

permissions: {}

jobs:
  release:
    if: github.repository_owner == 'OpenRouterTeam'
    name: Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          registry-url: "https://registry.npmjs.org"
          scope: "@openrouter"
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm changeset-version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: OIDC preflight - scrub .npmrc and verify registry
        run: |
          echo "=== OIDC Preflight ==="
          
          # Remove any auth tokens from .npmrc to ensure OIDC is used
          if [ -f ~/.npmrc ]; then
            echo "Cleaning ~/.npmrc of any existing auth tokens..."
            sed -i '/^\s*\/\/registry\.npmjs\.org\/:\s*_auth/d' ~/.npmrc
            sed -i '/^\s*\/\/registry\.npmjs\.org\/:\s*_authToken/d' ~/.npmrc
            sed -i '/^\s*\/\/registry\.npmjs\.org\/:\s*always-auth/d' ~/.npmrc
          fi
          
          # Verify npm connectivity
          echo "Testing npm registry connectivity..."
          npm ping || exit 1
          
          # Confirm no token is active (this should fail for OIDC to work)
          echo "Verifying no auth token is configured..."
          if npm whoami 2>&1 | grep -q "not logged in"; then
            echo "✓ Confirmed: not logged in (OIDC will be used)"
          else
            echo "⚠ Warning: npm whoami returned unexpected result"
          fi
          
          echo ""
          echo "Registry configuration:"
          npm config get registry
      
      - name: Publish with OIDC
        run: pnpm changeset-publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Post-mortem diagnostics
        if: failure()
        run: |
          echo "=== Post-mortem Diagnostics ==="
          echo "Node: $(node --version)"
          echo "npm: $(npm --version)"
          echo "pnpm: $(pnpm --version)"
          echo ""
          echo "Registry config:"
          npm config get registry
          echo ""
          echo ".npmrc status:"
          if [ -f ~/.npmrc ]; then
            echo "File exists:"
            wc -l ~/.npmrc
            echo "Auth token lines:"
            grep -c "authToken\|_auth" ~/.npmrc || echo "0"
          else
            echo "No .npmrc file"
          fi
          echo ""
          echo "Package info:"
          npm view @openrouter/ai-sdk-provider@latest version 2>&1 || echo "Could not fetch"
